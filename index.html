<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>–ê–¥–º–∏–Ω–∫–∞ - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* –ñ–µ—Å—Ç–∫–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ª–µ—Ç–∞–ª–æ */
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; background: #f0f0f0; }
        #map { 
            height: 100vh !important; 
            width: 100vw !important; 
            display: block;
            background: #e5e3df; /* –¶–≤–µ—Ç-–∑–∞–≥–ª—É—à–∫–∞, –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è –∫–∞—Ä—Ç–∞ */
        }
        .ui-element { position: absolute; z-index: 1000; }
        .controls-panel { 
            top: 10px; right: 10px; width: 160px; 
            background: white; padding: 10px; 
            border: 2px solid #333; border-radius: 8px;
            display: flex; flex-direction: column; gap: 5px;
        }
        .btn { cursor: pointer; padding: 8px; font-weight: bold; font-size: 11px; display: flex; align-items: center; gap: 5px; background: #eee; border: 1px solid #999; }
        .btn.active { background: #007bff; color: white; border-color: #0056b3; }
        .unit-icon { width: 30px; height: 30px; }
    </style>
</head>
<body>
    <div class="controls-panel ui-element">
        <button class="btn" onclick="setActiveMode('shahed', 's1.png')">–®–ê–•–ï–î</button>
        <button class="btn" onclick="setActiveMode('kab', 'kab.png')">–ö–ê–ë</button>
        <button class="btn" onclick="setActiveMode('su34', 'su34.png')">–°–£-34</button>
        <hr>
        <button class="btn" id="statusBtn" onclick="toggleMapStatus()">üü¢ –ö–ê–†–¢–ê –û–¢–ö–†–´–¢–ê</button>
        <button class="btn" style="color:red" onclick="setActiveMode('delete_one')">üóëÔ∏è –£–î–ê–õ–ò–¢–¨</button>
        <button class="btn" style="color:red" onclick="clearAllData()">‚ö†Ô∏è –û–ß–ò–°–¢–ò–¢–¨</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://map-objects-75fa0-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—å—Å—è
        const map = L.map('map').setView([48.3794, 31.1656], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ª–µ—á–∏–º "—Å–µ—Ä—ã–µ –∫–≤–∞–¥—Ä–∞—Ç—ã" –∏–ª–∏ –±–µ–ª—ã–π —ç–∫—Ä–∞–Ω
        setTimeout(() => { map.invalidateSize(); }, 200);

        let units = [], activeMode = null, activeIconUrl = '', currentUnit = null, mapActive = true;

        window.toggleMapStatus = () => {
            mapActive = !mapActive;
            document.getElementById('statusBtn').innerText = mapActive ? "üü¢ –ö–ê–†–¢–ê –û–¢–ö–†–´–¢–ê" : "üî¥ –ö–ê–†–¢–ê –ó–ê–ö–†–´–¢–ê";
            set(ref(db, 'map_status'), { active: mapActive });
        };

        window.setActiveMode = (mode, icon = '') => {
            activeMode = mode; activeIconUrl = icon;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            if(event) event.currentTarget.classList.add('active');
        };

        window.clearAllData = () => {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?")) {
                units.forEach(u => { map.removeLayer(u.marker); map.removeLayer(u.line); });
                units = []; set(ref(db, 'live_units'), []);
            }
        };

        map.on('click', (e) => {
            if (activeMode === 'delete_one') return;
            if (activeIconUrl && !currentUnit) {
                const u = { id: Date.now(), pos: e.latlng, type: activeMode, iconUrl: activeIconUrl, angle: 0, target: null };
                addMarker(u); units.push(u); currentUnit = u;
                sync();
            } else if (currentUnit) {
                currentUnit.target = e.latlng;
                currentUnit.angle = Math.atan2(e.latlng.lng - currentUnit.pos.lng, e.latlng.lat - currentUnit.pos.lat) * 180 / Math.PI;
                updateU(currentUnit); currentUnit = null; sync();
            }
        });

        function addMarker(u) {
            const icon = L.divIcon({ html: `<img src="${u.iconUrl}" class="unit-icon" style="transform:rotate(${u.angle}deg)">`, iconSize:[30,30], iconAnchor:[15,15], className:'' });
            u.marker = L.marker(u.pos, {icon:icon, draggable:true}).addTo(map);
            u.line = L.polyline([u.pos, u.target||u.pos], {color:'blue', weight:2, dashArray:'5,5'}).addTo(map);
            u.marker.on('drag', (e) => { u.pos = e.latlng; updateU(u); });
            u.marker.on('dragend', () => sync());
            u.marker.on('click', (ev) => {
                L.DomEvent.stopPropagation(ev);
                if(activeMode==='delete_one') { map.removeLayer(u.marker); map.removeLayer(u.line); units=units.filter(i=>i.id!==u.id); sync(); }
                else currentUnit = u;
            });
        }

        function updateU(u) {
            u.marker.setLatLng(u.pos); u.line.setLatLngs([u.pos, u.target||u.pos]);
            const img = u.marker.getElement()?.querySelector('img');
            if(img) img.style.transform = `rotate(${u.angle}deg)`;
        }

        function sync() {
            const data = units.map(u => ({ id: u.id, lat: u.pos.lat, lng: u.pos.lng, targetLat: u.target?.lat, targetLng: u.target?.lng, type: u.type, angle: u.angle, iconUrl: u.iconUrl }));
            set(ref(db, 'live_units'), data);
        }
    </script>
</body>
</html>
