<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>–ê–¥–º–∏–Ω–∫–∞ (–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ) - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #000; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        .ui-element { position: absolute; z-index: 1000; }
        .controls-panel { top: 10px; right: 10px; display: flex; flex-direction: column; gap: 4px; width: 150px; }
        .btn { background: rgba(25,25,25,0.95); color: white; border: 1px solid #444; padding: 6px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 10px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
        .btn img { width: 18px; height: 18px; pointer-events: none; }
        .btn.active { background: #0088ff; border-color: #fff; }
        .btn-danger { border-color: #ff4444; color: #ff4444; justify-content: center; }
        .unit-icon { display: block; pointer-events: none; width: 30px !important; height: 30px !important; }
    </style>
</head>
<body>

    <div class="controls-panel ui-element">
        <button class="btn" onclick="setActiveMode('shahed', 's1.png')"><img src="s1.png"> –®–ê–•–ï–î</button>
        <button class="btn" onclick="setActiveMode('kab', 'kab.png')"><img src="kab.png"> –ö–ê–ë</button>
        <button class="btn" onclick="setActiveMode('su34', 'su34.png')"><img src="su34.png"> –°–£-34</button>
        <hr style="width:100%; border:0; border-top:1px solid #444;">
        <button class="btn btn-danger" onclick="setActiveMode('delete_one')">üóëÔ∏è –£–î–ê–õ–ò–¢–¨</button>
        <button class="btn btn-danger" onclick="clearAllData()">‚ö†Ô∏è –û–ß–ò–°–¢–ò–¢–¨ –í–°–Å</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://map-objects-75fa0-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const map = L.map('map').setView([48.3794, 31.1656], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let activeMode = null, activeIconUrl = '', currentUnit = null, units = [];

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        function sync() {
            const data = units.map(u => ({
                id: u.id, lat: u.pos.lat, lng: u.pos.lng,
                targetLat: u.target ? u.target.lat : null,
                targetLng: u.target ? u.target.lng : null,
                type: u.type, angle: u.angle || 0, iconUrl: u.iconUrl
            }));
            set(ref(db, 'live_units'), data);
        }

        window.setActiveMode = (mode, icon = '') => {
            activeMode = mode; activeIconUrl = icon; currentUnit = null;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        window.clearAllData = () => {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?")) {
                units.forEach(u => { map.removeLayer(u.marker); if(u.line) map.removeLayer(u.line); });
                units = []; sync();
            }
        };

        map.on('click', (e) => {
            if (activeMode === 'delete_one') return;
            
            if (activeIconUrl && !currentUnit) {
                const newUnit = {
                    id: Date.now(), pos: e.latlng, target: null,
                    type: activeMode, iconUrl: activeIconUrl, angle: 0
                };
                addMarker(newUnit);
                units.push(newUnit);
                currentUnit = newUnit; // –¢–µ–ø–µ—Ä—å –∂–¥–µ–º –∫–ª–∏–∫–∞ –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∞
                sync();
            } else if (currentUnit) {
                currentUnit.target = e.latlng;
                currentUnit.angle = Math.atan2(e.latlng.lng - currentUnit.pos.lng, e.latlng.lat - currentUnit.pos.lat) * 180 / Math.PI;
                updateVisuals(currentUnit);
                currentUnit = null;
                sync();
            }
        });

        function addMarker(u) {
            const icon = L.divIcon({
                className: 'custom-div',
                html: `<img src="${u.iconUrl}" class="unit-icon" style="transform:rotate(${u.angle}deg)">`,
                iconSize: [30, 30], iconAnchor: [15, 15]
            });

            // draggable: true –≤–∫–ª—é—á–∞–µ—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞
            u.marker = L.marker(u.pos, { icon: icon, draggable: true }).addTo(map);
            u.line = L.polyline([u.pos, u.target || u.pos], { color: 'red', weight: 2, dashArray: '5,5' }).addTo(map);

            // –°–æ–±—ã—Ç–∏–µ –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø
            u.marker.on('drag', (e) => {
                u.pos = e.latlng;
                if (u.target) {
                    u.angle = Math.atan2(u.target.lng - u.pos.lng, u.target.lat - u.pos.lat) * 180 / Math.PI;
                }
                updateVisuals(u);
            });

            u.marker.on('dragend', () => {
                sync(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –≤ Firebase –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            });

            u.marker.on('click', (ev) => {
                L.DomEvent.stopPropagation(ev);
                if (activeMode === 'delete_one') {
                    map.removeLayer(u.marker); map.removeLayer(u.line);
                    units = units.filter(i => i.id !== u.id);
                    sync();
                } else {
                    currentUnit = u; // –í—ã–±–∏—Ä–∞–µ–º –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–∞
                }
            });
        }

        function updateVisuals(u) {
            u.marker.setLatLng(u.pos);
            u.line.setLatLngs([u.pos, u.target || u.pos]);
            const img = u.marker.getElement()?.querySelector('img');
            if (img) img.style.transform = `rotate(${u.angle}deg)`;
        }
    </script>
</body>
</html>
