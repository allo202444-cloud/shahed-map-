<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω–∫–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body, #map { margin: 0; padding: 0; height: 100%; width: 100%; background: #fff; }
        .menu { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border: 2px solid #000; display: flex; flex-direction: column; gap: 5px; }
        button { cursor: pointer; padding: 8px; font-weight: bold; border: 1px solid #333; }
        .active { background: #007bff; color: white; }
        .unit-icon { width: 32px; height: 32px; }
    </style>
</head>
<body>
    <div class="menu">
        <button onclick="setMode('shahed', 's1.png')">–®–ê–•–ï–î</button>
        <button onclick="setMode('kab', 'kab.png')">–ö–ê–ë</button>
        <button onclick="setMode('su34', 'su34.png')">–°–£-34</button>
        <hr>
        <button onclick="setMode('del', '')" style="color:red">üóëÔ∏è –£–î–ê–õ–ò–¢–¨</button>
        <button onclick="clearAll()" style="color:red">‚ö†Ô∏è –û–ß–ò–°–¢–ò–¢–¨ –í–°–Å</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://map-objects-75fa0-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const map = L.map('map').setView([48.3, 31.1], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let units = [], mode = '', icon = '', sel = null;

        window.setMode = (m, i) => { 
            mode = m; icon = i; sel = null; 
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            if(event) event.target.classList.add('active');
        };

        window.clearAll = () => { if(confirm('–°–Ω–µ—Å—Ç–∏ –≤—Å—ë?')) { units.forEach(u=>{map.removeLayer(u.m);map.removeLayer(u.l)}); units=[]; sync(); } };

        map.on('click', (e) => {
            if (mode === 'del') return;
            if (icon && !sel) {
                const u = { id: Date.now(), pos: e.latlng, icon: icon, ang: 0, tar: null };
                addU(u); units.push(u); sel = u; sync();
            } else if (sel) {
                sel.tar = e.latlng;
                sel.ang = Math.atan2(e.latlng.lng - sel.pos.lng, e.latlng.lat - sel.pos.lat) * 180 / Math.PI;
                updU(sel); sel = null; sync();
            }
        });

        function addU(u) {
            const i = L.divIcon({ html: `<img src="${u.icon}" class="unit-icon" style="transform:rotate(${u.ang}deg)">`, iconSize:[32,32], iconAnchor:[16,16], className:'' });
            u.m = L.marker(u.pos, {icon:i, draggable:true}).addTo(map);
            u.l = L.polyline([u.pos, u.tar||u.pos], {color:'blue', weight:2, dashArray:'5,5'}).addTo(map);
            u.m.on('drag', (e) => { u.pos = e.latlng; updU(u); });
            u.m.on('dragend', () => sync());
            u.m.on('click', (ev) => {
                L.DomEvent.stopPropagation(ev);
                if(mode==='del') { map.removeLayer(u.m); map.removeLayer(u.l); units=units.filter(x=>x.id!==u.id); sync(); }
                else sel = u;
            });
        }

        function updU(u) {
            u.m.setLatLng(u.pos); u.l.setLatLngs([u.pos, u.tar||u.pos]);
            const img = u.m.getElement()?.querySelector('img');
            if(img) img.style.transform = `rotate(${u.ang}deg)`;
        }

        function sync() {
            const data = units.map(u => ({ id: u.id, lat: u.pos.lat, lng: u.pos.lng, tLat: u.tar?.lat, tLng: u.tar?.lng, ang: u.ang, icon: u.icon }));
            set(ref(db, 'live_units'), data);
        }
    </script>
</body>
</html>
