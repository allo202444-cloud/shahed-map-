–î–∞–Ω–∏–ª, [20.02.2026 17:47]
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>–ê–¥–º–∏–Ω–∫–∞ - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #f0f0f0; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #f0f0f0; }
        .ui-element { position: absolute; z-index: 1000; }
        .controls-panel { top: 10px; right: 10px; display: flex; flex-direction: column; gap: 4px; width: 160px; background: rgba(0,0,0,0.85); padding: 8px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .btn { background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 10px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; transition: 0.2s; }
        .btn img { width: 18px; height: 18px; pointer-events: none; background: rgba(255,255,255,0.1); border-radius: 2px; }
        .btn:hover { background: #333; }
        .btn.active { background: #0088ff; border-color: #fff; }
        .btn-danger { border-color: #ff4444; color: #ff4444; justify-content: center; }
        .btn-status { background: #333; border: 1px solid #555; margin-top: 5px; justify-content: center; }
        .unit-icon { display: block; pointer-events: none; width: 30px !important; height: 30px !important; }
    </style>
</head>
<body>

    <div class="controls-panel ui-element">
        <button class="btn" onclick="setActiveMode('shahed', 's1.png', this)"><img src="s1.png"> –®–ê–•–ï–î</button>
        <button class="btn" onclick="setActiveMode('kab', 'kab.png', this)"><img src="kab.png"> –ö–ê–ë</button>
        <button class="btn" onclick="setActiveMode('su34', 'su34.png', this)"><img src="su34.png"> –°–£-34</button>
        <button class="btn" onclick="setActiveMode('uav-unknown', 'uav.png', this)"><img src="uav.png"> –ù–ï–£–°–¢.</button>
        
        <hr style="width:100%; border:0; border-top:1px solid #444; margin: 5px 0;">
        
        <button class="btn btn-status" id="statusBtn" onclick="toggleMapStatus()">üü¢ –ö–ê–†–¢–ê –û–¢–ö–†–´–¢–ê</button>
        <button class="btn btn-danger" onclick="setActiveMode('delete_one', '', this)">üóëÔ∏è –£–î–ê–õ–ò–¢–¨ –û–î–ù–£</button>
        <button class="btn btn-danger" onclick="clearAllData()">‚ö†Ô∏è –û–ß–ò–°–¢–ò–¢–ò –í–°–ï</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // –¢–≤–æ—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
        const firebaseConfig = { databaseURL: "https://map-objects-75fa0-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map', { zoomControl: false }).setView([48.3794, 31.1656], 6);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Voyager —Å–ª–æ–π - –æ–Ω —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ –¥–ª—è GitHub/HTTPS
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        let activeMode = null, activeIconUrl = '', currentUnit = null, units = [], mapActive = true;

        // –§–ò–ù–ö–°: –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è HTML –∫–Ω–æ–ø–æ–∫
        window.setActiveMode = (mode, icon = '', el) => {
            activeMode = mode; 
            activeIconUrl = icon; 
            currentUnit = null;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            if(el) el.classList.add('active');
        };

–î–∞–Ω–∏–ª, [20.02.2026 17:47]
window.toggleMapStatus = () => {
            mapActive = !mapActive;
            const btn = document.getElementById('statusBtn');
            btn.innerText = mapActive ? "üü¢ –ö–ê–†–¢–ê –û–¢–ö–†–´–¢–ê" : "üî¥ –ö–ê–†–¢–ê –ó–ê–ö–†–´–¢–ê";
            btn.style.background = mapActive ? "#333" : "#ff0000";
            set(ref(db, 'map_status'), { active: mapActive });
        };

        window.clearAllData = () => {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ü–µ–ª–∏?")) {
                units.forEach(u => { 
                    map.removeLayer(u.marker); 
                    if(u.line) map.removeLayer(u.line); 
                });
                units = []; 
                sync();
            }
        };

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Firebase
        function sync() {
            const data = units.map(u => ({
                id: u.id, lat: u.pos.lat, lng: u.pos.lng,
                targetLat: u.target ? u.target.lat : null,
                targetLng: u.target ? u.target.lng : null,
                type: u.type, angle: u.angle || 0, iconUrl: u.iconUrl
            }));
            set(ref(db, 'live_units'), data);
        }

        map.on('click', (e) => {
            if (activeMode === 'delete_one') return;
            
            if (activeIconUrl && !currentUnit) {
                const newUnit = {
                    id: Date.now(), pos: e.latlng, target: null,
                    type: activeMode, iconUrl: activeIconUrl, angle: 0
                };
                addMarker(newUnit);
                units.push(newUnit);
                currentUnit = newUnit;
                sync();
            } else if (currentUnit) {
                currentUnit.target = e.latlng;
                currentUnit.angle = Math.atan2(e.latlng.lng - currentUnit.pos.lng, e.latlng.lat - currentUnit.pos.lat) * 180 / Math.PI;
                updateVisuals(currentUnit);
                currentUnit = null;
                sync();
            }
        });

        function addMarker(u) {
            const icon = L.divIcon({
                className: 'custom-div',
                html: <img src="${u.iconUrl}" class="unit-icon" style="transform:rotate(${u.angle}deg)" onerror="this.style.background='red'">,
                iconSize: [30, 30], iconAnchor: [15, 15]
            });

            u.marker = L.marker(u.pos, { icon: icon, draggable: true }).addTo(map);
            u.line = L.polyline([u.pos, u.target || u.pos], { color: 'red', weight: 2, dashArray: '5,5', opacity: 0.5 }).addTo(map);

            u.marker.on('drag', (e) => {
                u.pos = e.latlng;
                if (u.target) {
                    u.angle = Math.atan2(u.target.lng - u.pos.lng, u.target.lat - u.pos.lat) * 180 / Math.PI;
                }
                updateVisuals(u);
            });

            u.marker.on('dragend', () => sync());

            u.marker.on('click', (ev) => {
                L.DomEvent.stopPropagation(ev);
                if (activeMode === 'delete_one') {
                    map.removeLayer(u.marker); map.removeLayer(u.line);
                    units = units.filter(i => i.id !== u.id);
                    sync();
                } else {
                    currentUnit = u;
                }
            });
        }

        function updateVisuals(u) {
            u.marker.setLatLng(u.pos);
            u.line.setLatLngs([u.pos, u.target || u.pos]);
            const img = u.marker.getElement()?.querySelector('img');
            if (img) img.style.transform = rotate(${u.angle}deg);
        }

        // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º "—Ä–≤–∞–Ω—É—é" –∫–∞—Ä—Ç—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            setTimeout(() => { map.invalidateSize(); }, 500);
        });
    </script>
</body>
</html>
