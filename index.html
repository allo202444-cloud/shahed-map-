
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>–ê–¥–º—ñ–Ω–∫–∞: LIVE CONTROL</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; background: #000; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        .panel { 
            position: absolute; top: 10px; right: 10px; z-index: 1000; 
            background: rgba(255, 255, 255, 0.95); padding: 10px; 
            border-radius: 8px; display: flex; flex-direction: column; gap: 5px; 
            border: 1px solid #333; width: 150px;
        }
        
        .btn { 
            cursor: pointer; padding: 8px; font-weight: bold; font-size: 11px; 
            border: 1px solid #999; background: #fff; text-align: left;
            display: flex; align-items: center; gap: 8px; border-radius: 4px;
        }
        .btn img { width: 22px; height: 22px; object-fit: contain; }
        .btn.active { background: #ff4444; color: white; border-color: red; }
        
        .unit-icon { 
            display: block; width: 32px !important; height: 32px !important; 
            transition: transform 0.1s linear; 
        }
    </style>
</head>
<body>

    <div class="panel">
        <button class="btn" onclick="setMode('sh', 's1.png')"><img src="s1.png"> –®–ê–•–ï–î</button>
        <button class="btn" onclick="setMode('kb', 'kab.png')"><img src="kab.png"> –ö–ê–ë</button>
        <button class="btn" onclick="setMode('su', 'su34.png')"><img src="su34.png"> –°–£-34</button>
        <hr style="width:100%">
        <button class="btn" style="color:red" onclick="setMode('del', '')">üóëÔ∏è –í–ò–î–ê–õ–ò–¢–ò</button>
        <button class="btn" style="color:red" onclick="clearAll()">‚ö†Ô∏è –û–ß–ò–°–¢–ò–¢–ò –í–°–ï</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const METER_LAT = 111320;
        const map = L.map('map', { zoomControl: false }).setView([48.37, 31.16], 6);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let activeMode = null, activeIcon = '', currentUnit = null, units = [];

        function setMode(mode, icon) {
            activeMode = mode; activeIcon = icon; currentUnit = null;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            if(event && event.currentTarget) event.currentTarget.classList.add('active');
        }

        window.clearAll = () => {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —Ü—ñ–ª—ñ?")) {
                units.forEach(u => { 
                    map.removeLayer(u.marker); 
                    map.removeLayer(u.vector); 
                    map.removeLayer(u.trail); 
                });
                units = [];
            }
        };

        map.on('click', (e) => {
            if (activeMode === 'del') return;

            if (activeIcon && !currentUnit) {
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ DivIcon –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è
                const iconHTML = L.divIcon({
                    className: 'custom-icon',
                    html: <img src="${activeIcon}" class="unit-icon" style="transform: rotate(0deg);">,
                    iconSize: [32, 32], iconAnchor: [16, 16]
                });

                const marker = L.marker(e.latlng, { icon: iconHTML }).addTo(map);
                const vector = L.polyline([e.latlng, e.latlng], { color: 'blue', weight: 2, dashArray: '5,5' }).addTo(map);
                const trail = L.polyline([e.latlng], { color: '#FF0000', weight: 5, opacity: 0.6, lineJoin: 'round' }).addTo(map);

–î–∞–Ω–∏–ª, [20.02.2026 14:59]
const u = {
                    id: Date.now(),
                    marker, vector, trail,
                    pos: e.latlng,
                    angle: 0,
                    speed: 180,
                    history: [e.latlng],
                    moving: false
                };

                marker.on('click', (ev) => {
                    L.DomEvent.stopPropagation(ev);
                    if(activeMode === 'del') {
                        map.removeLayer(marker); map.removeLayer(vector); map.removeLayer(trail);
                        units = units.filter(x => x.id !== u.id);
                    } else {
                        currentUnit = u; 
                    }
                });

                units.push(u);
                currentUnit = u; 
            } else if (currentUnit) {
                const target = e.latlng;
                const uAngle = Math.atan2(target.lng - currentUnit.pos.lng, target.lat - currentUnit.pos.lat) * (180 / Math.PI);
                
                currentUnit.angle = uAngle;
                currentUnit.vector.setLatLngs([currentUnit.pos, target]);
                
                const img = currentUnit.marker.getElement().querySelector('img');
                if(img) img.style.transform = rotate(${uAngle}deg);
                
                currentUnit.moving = true;
                currentUnit = null;
            }
        });

        // –¶–∏–∫–ª –¥–≤–∏–∂–µ–Ω–∏—è
        setInterval(() => {
            units.forEach(u => {
                if (!u.moving) return;
                const step = (u.speed / 3.6) * 0.1;
                const rad = u.angle * Math.PI / 180;
                const curr = u.marker.getLatLng();
                const dLat = (step * Math.cos(rad)) / METER_LAT;
                const dLng = (step * Math.sin(rad)) / (METER_LAT * Math.cos(curr.lat * Math.PI / 180));
                const newPos = L.latLng(curr.lat + dLat, curr.lng + dLng);

                u.pos = newPos;
                u.marker.setLatLng(newPos);
                u.history.push(newPos);
                u.trail.setLatLngs(u.history);

                const vPts = u.vector.getLatLngs();
                const diffLat = newPos.lat - vPts[0].lat;
                const diffLng = newPos.lng - vPts[0].lng;
                u.vector.setLatLngs([newPos, L.latLng(vPts[1].lat + diffLat, vPts[1].lng + diffLng)]);
            });
        }, 100);
    </script>
</body>
</html>
