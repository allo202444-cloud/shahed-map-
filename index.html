<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ADMIN PANEL</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
        #map { height: 100vh !important; width: 100vw !important; background: #ddd; }
        .menu { position: absolute; top: 10px; right: 10px; z-index: 9999; background: white; padding: 10px; border: 2px solid black; display: flex; flex-direction: column; gap: 5px; }
        button { cursor: pointer; padding: 5px; font-weight: bold; }
        .unit-icon { width: 30px; height: 30px; }
    </style>
</head>
<body>
    <div class="menu">
        <button onclick="setActiveMode('shahed', 's1.png')">–®–ê–•–ï–î</button>
        <button onclick="setActiveMode('kab', 'kab.png')">–ö–ê–ë</button>
        <button onclick="setActiveMode('su34', 'su34.png')">–°–£-34</button>
        <hr>
        <button id="statusBtn" onclick="toggleMapStatus()" style="background: lightgreen;">üü¢ –ö–ê–†–¢–ê –û–¢–ö–†–´–¢–ê</button>
        <button onclick="setActiveMode('delete_one', '')" style="color: red;">üóëÔ∏è –£–î–ê–õ–ò–¢–¨ –û–î–ù–£</button>
        <button onclick="clearAll()" style="color: red;">‚ö†Ô∏è –û–ß–ò–°–¢–ò–¢–¨ –í–°–Å</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://map-objects-75fa0-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const map = L.map('map').setView([48.3, 31.1], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let units = [], activeMode = null, activeIcon = '', currentUnit = null, mapActive = true;

        window.toggleMapStatus = () => {
            mapActive = !mapActive;
            document.getElementById('statusBtn').innerText = mapActive ? "üü¢ –ö–ê–†–¢–ê –û–¢–ö–†–´–¢–ê" : "üî¥ –ö–ê–†–¢–ê –ó–ê–ö–†–´–¢–ê";
            document.getElementById('statusBtn').style.background = mapActive ? "lightgreen" : "red";
            set(ref(db, 'map_status'), { active: mapActive });
        };

        window.setActiveMode = (mode, icon) => { activeMode = mode; activeIcon = icon; currentUnit = null; };

        window.clearAll = () => { if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?')) { units.forEach(u => {map.removeLayer(u.m); map.removeLayer(u.l);}); units=[]; sync(); } };

        map.on('click', (e) => {
            if (activeMode === 'delete_one') return;
            if (activeIcon && !currentUnit) {
                const u = { id: Date.now(), pos: e.latlng, type: activeMode, icon: activeIcon, ang: 0, target: null };
                addU(u); units.push(u); currentUnit = u; sync();
            } else if (currentUnit) {
                currentUnit.target = e.latlng;
                currentUnit.ang = Math.atan2(e.latlng.lng - currentUnit.pos.lng, e.latlng.lat - currentUnit.pos.lat) * 180 / Math.PI;
                updU(currentUnit); currentUnit = null; sync();
            }
        });

        function addU(u) {
            const icon = L.divIcon({ html: `<img src="${u.icon}" class="unit-icon" style="transform:rotate(${u.ang}deg)">`, iconSize:[30,30], iconAnchor:[15,15], className:'' });
            u.m = L.marker(u.pos, {icon:icon, draggable:true}).addTo(map);
            u.l = L.polyline([u.pos, u.target||u.pos], {color:'blue', weight:2, dashArray:'5,5'}).addTo(map);
            u.m.on('drag', (e) => { u.pos = e.latlng; updU(u); });
            u.m.on('dragend', () => sync());
            u.m.on('click', (ev) => {
                L.DomEvent.stopPropagation(ev);
                if(activeMode==='delete_one') { map.removeLayer(u.m); map.removeLayer(u.l); units=units.filter(i=>i.id!==u.id); sync(); }
                else currentUnit = u;
            });
        }

        function updU(u) {
            u.m.setLatLng(u.pos); u.l.setLatLngs([u.pos, u.target||u.pos]);
            const img = u.m.getElement()?.querySelector('img');
            if(img) img.style.transform = `rotate(${u.ang}deg)`;
        }

        function sync() {
            const data = units.map(u => ({ id: u.id, lat: u.pos.lat, lng: u.pos.lng, tLat: u.target?.lat, tLng: u.target?.lng, type: u.type, ang: u.ang, icon: u.icon }));
            set(ref(db, 'live_units'), data);
        }
    </script>
</body>
</html>
